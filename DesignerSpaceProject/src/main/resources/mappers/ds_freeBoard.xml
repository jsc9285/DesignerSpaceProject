<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.freeBoard">

	<resultMap type="com.project.freeBoard.model.FreeBoardDto" 
		id="freeBoardResultMap">
		<result column="free_board_no"		property="freeBoardNo"			/>
		<result column="free_board_mno"		property="freeBoardMno"			/>
		<result column="free_board_title"		property="freeBoardTitle"			/>
		<result column="free_board_contents"		property="freeBoardContents"			/>
		<result column="free_board_views"			property="freeBoardViews"			/>
		<result column="nl"		property="freeBoardLike"			/>
		<result column="rownum"		property="freeBoardRownum"			/>
		<result column="free_board_cre_date"		property="freeBoardCreDate"		javaType="java.util.Date"/>
		<result column="free_board_mod_date"		property="freeBoardModDate"		javaType="java.util.Date"/>
		
		<result column="free_like_no"	property="freeLikeNo"		/>
		<result column="free_like_mno"	property="freeLikeMno"		/>
		<result column="free_like_fbno"	property="freeLikeFbno"		/>
		<result column="free_like_flag"	property="freeLikeFlag"		/>
		
		
		<result column="free_comment_no"         	property="freeCommentNo"			/>
		<result column="free_comment_fbno"         	property="freeCommentFbno"			/>
		<result column="free_comment_mno"         	property="freeCommentMno"			/>
		<result column="free_comment_comments"         	property="freeCommentComments"			/>
		<result column="free_comment_cre_date"         	property="freeCommentCreDate"			javaType="java.util.Date"/>	
		<result column="free_comment_mod_date"         	property="freeCommentModDate"			javaType="java.util.Date"/>
		
		<result column="member_no"	property="memberNo"	/>
		<result column="member_name"	property="memberName"	/>
		<result column="member_nick"	property="memberNick"	/>
		<result column="member_email"	property="memberEmail"	/>
		<result column="member_pwd"	property="memberPwd"	/>
		<result column="member_phone"	property="memberPhone"	/>
		<result column="member_check_question"	property="memberCheckQuestion"			/>
		<result column="member_check_answer"	property="memberCheckAnswer"			/>
		<result column="member_comments"	property="memberComments"		/>
		<result column="member_sign_check"	property="memberSignCheck"		/>
		<result column="member_del_flag"	property="memberDelFlag"		/>
		<result column="member_cre_date"	property="memberCreDate"		javaType="java.util.Date"/>
		<result column="member_mod_date"	property="memberModDate"		javaType="java.util.Date"/>
		<result column="member_grade"	property="memberGrade"			/>
		                                                      
		                                                      
		<result column="PROFILE_TABLE_NO"	property="profileTableNo"					/>
		<result column="PROFILE_TABLE_MNO"	property="profileTableMno"					/>
		<result column="PROFILE_TABLE_ORIGINAL_NAME"		property="profileTableOriginalName"		/>
		<result column="PROFILE_TABLE_STORED_NAME"		property="profileTableStoredName"			/>
		
			
	</resultMap>
	
	<sql id="freeBoardSearch">
		<choose>
        	<!-- 검색옵션이 전체 검색일 경우  -->
        	<when test="searchOption == 'all'">
        		and (fb.free_board_title LIKE '%' || #{keyword} || '%'
        		OR   m.member_nick LIKE '%' || #{keyword} || '%')
        	</when>
        	
        	<!-- 전체 검색이 아닐 경우 -->
        	<otherwise>
        		and (${searchOption} LIKE '%' || #{keyword} || '%')
        	</otherwise>
        </choose>
	</sql>
	
	
	<select id="freeBoardSelectTotalCount" resultType="int" 
		parameterType="map">
		select count(*) 
		from free_board fb, member m
		where fb.free_board_mno = m.member_no
		<include refid="freeBoardSearch"></include>
	</select>
	
	<select id="freeBoardSelectCurPage" parameterType="map"
		resultType="int">
		select floor((rnum-1) / 10)+1 no
		from (
		    select rownum rnum,f.free_board_no, f.free_board_title, f.member_no, f.free_board_views, f.member_nick, f.free_board_cre_date, f.free_board_contents,f.nl
		    from (
		            select fb.free_board_no, fb.free_board_title, m.member_no, fb.free_board_views, m.member_nick ,fb.free_board_cre_date, fb.free_board_contents, l.nl
		            from free_board fb, member m
			            ,(select nvl(count(fl.free_like_no),0) nl, fb.free_board_no
			              from free_board fb left join free_like fl
			              on fb.free_board_no = fl.free_like_fbno
			              group by fb.free_board_no)l
                     where fb.free_board_no = l.free_board_no
                     and fb.free_board_mno = m.member_no
                     <include refid="freeBoardSearch"></include>
                     order by fb.free_board_cre_date desc) f
		    )ff
		where ff.free_board_no = #{no}
	</select>
	
	<select id="freeBoardSelectList" parameterType="map"
		resultMap="freeBoardResultMap">
		select ff.rnum,ff.free_board_no, ff.free_board_title, ff.member_no, ff.free_board_views, ff.member_nick, ff.free_board_cre_date, ff.free_board_contents,ff.nl
		from (
		select rownum rnum,f.free_board_no, f.free_board_title, f.member_no, f.free_board_views, f.member_nick, f.free_board_cre_date, f.free_board_contents,f.nl
		from (
		        select fb.free_board_no, fb.free_board_title, m.member_no, fb.free_board_views, m.member_nick ,fb.free_board_cre_date, fb.free_board_contents, l.nl
		        from free_board fb, member m,(select nvl(count(fl.free_like_no),0) nl, fb.free_board_no
		                                        from free_board fb left join free_like fl
		                                        on fb.free_board_no = fl.free_like_fbno
		                                        group by fb.free_board_no)l
		                                        where fb.free_board_no = l.free_board_no
		                                        and fb.free_board_mno = m.member_no
		                                       	<include refid="freeBoardSearch"></include>
		                                        order by fb.free_board_no desc)f
		                                        )ff                                    
		where rnum between #{start} and #{end}
	</select>
	
	
	<select id="freeBoardSelectOne" parameterType="int"
		resultMap="freeBoardResultMap">
		select ff.rnum,ff.free_board_no, ff.free_board_title, ff.member_no, ff.free_board_views, ff.member_nick, ff.free_board_cre_date, ff.free_board_contents,ff.nl
		from (
		select rownum rnum,f.free_board_no, f.free_board_title, f.member_no, f.free_board_views, f.member_nick, f.free_board_cre_date, f.free_board_contents,f.nl
		from (
		        select fb.free_board_no, fb.free_board_title, m.member_no, fb.free_board_views, m.member_nick ,fb.free_board_cre_date, fb.free_board_contents, l.nl
		        from free_board fb, member m,(select nvl(count(fl.free_like_no),0) nl, fb.free_board_no
		                                        from free_board fb left join free_like fl
		                                        on fb.free_board_no = fl.free_like_fbno
		                                        group by fb.free_board_no)l
		                                        where fb.free_board_no = l.free_board_no
		                                        and fb.free_board_mno = m.member_no
		                                        order by fb.free_board_no desc)f
		                                        )ff
		where ff.free_board_no = #{no}
	</select>
	
	<update id="freeBoardView" parameterType="int">
      	update free_board
		set 
		free_board_views =  free_board_views +1
		where free_board_no = #{no}
   	</update>
	
	
	
	<select id="freeBoardCommentSelectTotalCount" resultType="int" 
		parameterType="int">
		select count(*)
		from (select rownum rnum,fbm.free_comment_no,fbm.free_comment_comments,fbm.free_comment_cre_date, fbm.member_name, fbm.profile_table_stored_name
		    from (
		        select fc.free_comment_no,fc.free_comment_comments,fc.free_comment_cre_date, m.member_name, pt.profile_table_stored_name
		        from free_board fb , free_comment fc, member m, profile_table pt
		        where fb.free_board_no = fc.free_comment_fbno
		        and fc.free_comment_mno = m.member_no
		        and m.member_no = pt.profile_table_mno
		        and fb.free_board_no = #{no}
		        order by fc.free_comment_no desc)fbm
		        )
	</select>
	
<!-- 	<select id="freeBoardCommentSelectCurPage" parameterType="map" -->
<!-- 		resultType="int"> -->
<!-- 		select floor((rnum-1) / 10)+1 no -->
<!-- 		from (select rownum rnum,fbm.free_board_no,fbm.free_comment_no,fbm.free_comment_comments,fbm.free_comment_cre_date, fbm.member_name, fbm.profile_table_stored_name -->
<!-- 		    from ( -->
<!-- 		        select fb.free_board_no, fc.free_comment_no,fc.free_comment_comments,fc.free_comment_cre_date, m.member_name, pt.profile_table_stored_name -->
<!-- 		        from free_board fb , free_comment fc, member m, profile_table pt -->
<!-- 		        where fb.free_board_no = fc.free_comment_fbno -->
<!-- 		        and fc.free_comment_mno = m.member_no -->
<!-- 		        and m.member_no = pt.profile_table_mno -->
<!--                 and fb.free_board_no = #{no} -->
<!-- 		        order by fc.free_comment_no desc)fbm -->
<!-- 		        )c -->
<!-- 		where c.free_comment_no = #{fcno} -->
<!-- 	</select> -->
	
	<select id="freeBoardCommentSelectList" parameterType="map"
		resultMap="freeBoardResultMap">
		
		SELECT *
		FROM (SELECT ROWNUM RNUM,FBM.FREE_COMMENT_NO,FBM.FREE_COMMENT_COMMENTS,FBM.FREE_COMMENT_CRE_DATE, FBM.MEMBER_NICK, FBM.PROFILE_TABLE_STORED_NAME
		    FROM (
		        SELECT FC.FREE_COMMENT_NO,FC.FREE_COMMENT_COMMENTS,FC.FREE_COMMENT_CRE_DATE, M.MEMBER_NICK, PT.PROFILE_TABLE_STORED_NAME
		        FROM FREE_BOARD FB , FREE_COMMENT FC, MEMBER M, PROFILE_TABLE PT
		        WHERE FB.FREE_BOARD_NO = FC.FREE_COMMENT_FBNO
		        AND FC.FREE_COMMENT_MNO = M.MEMBER_NO
		        AND M.MEMBER_NO = PT.PROFILE_TABLE_MNO
		        AND FB.FREE_BOARD_NO = #{no}
		        ORDER BY FC.FREE_COMMENT_NO DESC)FBM
		        )
<!-- 		WHERE RNUM BETWEEN #{start} AND #{end} -->
		<![CDATA[WHERE RNUM <= #{end}]]>
		
		
	</select>
	
	
</mapper>